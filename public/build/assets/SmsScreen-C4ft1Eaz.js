import{r as u,W as H,j as e,a as U,y as W}from"./app-D1vVKMss.js";import{r}from"./index-CIcOjg0T.js";import{Q as G,B as l}from"./react-toastify.esm-DRcUxu9x.js";/* empty css                      */import{u as z,c as Y}from"./index.es-slHSpSGb.js";import{L as A}from"./Layout-B8WdVVx_.js";function I({company:a,smsBalance:c,sentSms:g,bundles:y,maxLength:d}){var v,N,T,M;const[t,m]=u.useState(null),[C,p]=u.useState(!1),[h,x]=u.useState(0),[i,j]=u.useState(0),{data:f,setData:S,post:w,processing:b,errors:o,reset:X}=H({message:"",recipients:""}),_={public_key:"FLWPUBK_TEST-03db37124e5570cb191b65425abfb963-X",tx_ref:Date.now().toString(),amount:(t==null?void 0:t.price)||1e3,currency:"UGX",payment_options:"mobilemoney, card",customer:{email:((v=a==null?void 0:a.user)==null?void 0:v.email)||((N=a==null?void 0:a.company)==null?void 0:N.email)||"customer@example.com",phone_number:((T=a==null?void 0:a.company)==null?void 0:T.contacts)||"256700000000",name:((M=a==null?void 0:a.company)==null?void 0:M.name)||"Customer"},customizations:{title:"SMS Top-up",description:t?`${t.name} - ${t.sms_count} SMS`:"SMS Bundle Purchase",logo:"https://biashari.com/images/logo.png"}},P=z(_),D=s=>{const n=` - ${a.company.name}`;return s.length+n.length},F=s=>s.trim()?s.split(/[\s,\n\r]+/).filter(L=>L.trim().length>0).length:0,$=s=>{const n=s.target.value;S("message",n),x(D(n))},k=s=>{const n=s.target.value;S("recipients",n),j(F(n))},B=s=>{if(s.preventDefault(),i===0){l.error("Please enter at least one valid phone number");return}if(c<i){l.error(`Insufficient SMS balance. You need ${i} SMS but have only ${c}`);return}if(h>d){l.error(`Message too long. Maximum ${d} characters including company name`);return}l.loading("Sending SMS..."),w(route("sms.send",a.company.slug),{preserveScroll:!0,onSuccess:()=>{l.dismiss(),l.success("SMS sent successfully!"),X(),x(0),j(0)},onError:()=>{l.dismiss(),o.balance?l.error(o.balance):o.recipients?l.error(o.recipients):l.error("Failed to send SMS")}})},E=s=>{m(s),p(!0)},R=()=>{if(!t){l.error("Please select a bundle");return}console.log("Opening FlutterWave payment for bundle:",t),p(!1),P({callback:s=>{Y(),s.status==="successful"||s.status==="completed"?W.post(route("sms.topup",a.company.slug),{bundle_id:t.id,transaction_reference:String(s.transaction_id||s.tx_ref||"N/A"),payment_method:String(s.payment_type||"flutterwave")},{preserveScroll:!1,onSuccess:()=>{l.success("SMS credits added successfully!"),m(null)},onError:()=>{l.error("Failed to process top-up")}}):l.error("Payment was not completed")},onClose:()=>{l.info("Payment cancelled"),m(null)}})};return e.jsxs(e.Fragment,{children:[e.jsx(U,{title:"SMS Messaging"}),e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx(r.Typography,{variant:"h4",color:"blue-gray",className:"mb-2",children:"SMS Messaging"}),e.jsx(r.Typography,{variant:"small",color:"gray",children:"Send SMS messages to your customers"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx("div",{className:"lg:col-span-2",children:e.jsxs(r.Card,{children:[e.jsx(r.CardHeader,{floated:!1,shadow:!1,className:"rounded-none bg-gradient-to-r from-primary to-secondary p-6",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(r.Typography,{variant:"h5",color:"white",children:"Compose Message"}),e.jsx(r.Chip,{value:`${c} SMS Credits`,color:c>10?"green":"red",className:"text-white"})]})}),e.jsx(r.CardBody,{children:e.jsxs("form",{onSubmit:B,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(r.Typography,{variant:"small",color:"blue-gray",className:"mb-2 font-medium",children:"Recipients (Phone Numbers)"}),e.jsx(r.Textarea,{label:"Enter phone numbers (256XXXXXXXXX or +256XXXXXXXXX)",value:f.recipients,onChange:k,rows:4,error:!!o.recipients}),e.jsxs(r.Typography,{variant:"small",color:"gray",className:"mt-1",children:["Separate numbers with comma, space, or new line. ",i," recipient(s)"]}),o.recipients&&e.jsx(r.Typography,{variant:"small",color:"red",className:"mt-1",children:o.recipients})]}),e.jsxs("div",{children:[e.jsx(r.Typography,{variant:"small",color:"blue-gray",className:"mb-2 font-medium",children:"Message"}),e.jsx(r.Textarea,{label:"Type your message here",value:f.message,onChange:$,rows:6,error:!!o.message||h>d}),e.jsxs("div",{className:"flex justify-between mt-1",children:[e.jsxs(r.Typography,{variant:"small",color:"gray",children:['Company name will be appended: " - ',a.company.name,'"']}),e.jsxs(r.Typography,{variant:"small",color:h>d?"red":"gray",children:[h,"/",d," characters"]})]}),o.message&&e.jsx(r.Typography,{variant:"small",color:"red",className:"mt-1",children:o.message})]}),o.balance&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:e.jsx(r.Typography,{variant:"small",color:"red",children:o.balance})}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs(r.Typography,{variant:"small",color:"blue-gray",children:["Cost: ",i," SMS credit(s)"]}),e.jsx(r.Button,{type:"submit",disabled:b||i===0||c<i,className:"bg-gradient-to-r from-primary to-secondary",children:b?"Sending...":"Send SMS"})]})]})})]})}),e.jsxs("div",{children:[e.jsxs(r.Card,{children:[e.jsx(r.CardHeader,{floated:!1,shadow:!1,className:"rounded-none bg-gray-100 p-4",children:e.jsx(r.Typography,{variant:"h6",color:"blue-gray",children:"Top-up SMS Credits"})}),e.jsx(r.CardBody,{className:"space-y-3",children:y.length===0?e.jsx(r.Typography,{variant:"small",color:"gray",children:"No bundles available"}):y.map(s=>e.jsx("div",{className:"border border-gray-200 rounded-lg p-4 hover:border-primary cursor-pointer transition-colors",onClick:()=>E(s),children:e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{children:[e.jsx(r.Typography,{variant:"small",color:"gray",className:"text-xs",children:s.name}),e.jsxs(r.Typography,{variant:"h6",color:"blue-gray",children:[s.sms_count," SMS"]})]}),e.jsx(r.Chip,{value:`UGX ${s.price.toLocaleString()}`,color:"green",size:"sm"})]})},s.id))})]}),e.jsxs(r.Card,{className:"mt-4",children:[e.jsx(r.CardHeader,{floated:!1,shadow:!1,className:"rounded-none bg-gray-100 p-4",children:e.jsx(r.Typography,{variant:"h6",color:"blue-gray",children:"Recent Messages"})}),e.jsx(r.CardBody,{className:"space-y-2",children:g.data.length===0?e.jsx(r.Typography,{variant:"small",color:"gray",children:"No messages sent yet"}):g.data.slice(0,5).map(s=>e.jsxs("div",{className:"border-b border-gray-100 pb-2",children:[e.jsxs(r.Typography,{variant:"small",color:"blue-gray",className:"font-medium",children:[s.total_sent," recipient(s)"]}),e.jsxs(r.Typography,{variant:"small",color:"gray",className:"truncate",children:[s.message.substring(0,50),"..."]}),e.jsx(r.Typography,{variant:"small",color:"gray",children:new Date(s.created_at).toLocaleDateString()})]},s.id))})]})]})]}),e.jsxs(r.Dialog,{open:C,handler:()=>p(!1),children:[e.jsx(r.DialogHeader,{children:"Confirm SMS Top-up"}),e.jsx(r.DialogBody,{divider:!0,children:t&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs(r.Typography,{children:["You are about to purchase ",e.jsxs("strong",{children:[t.sms_count," SMS credits"]})," for ",e.jsxs("strong",{children:["UGX ",t.price.toLocaleString()]}),"."]}),e.jsx(r.Typography,{variant:"small",color:"gray",children:'Payment will be processed through FlutterWave. Click "Proceed to Payment" to continue.'})]})}),e.jsxs(r.DialogFooter,{children:[e.jsx(r.Button,{variant:"text",color:"gray",onClick:()=>{p(!1),m(null)},className:"mr-2",children:"Cancel"}),e.jsx(r.Button,{onClick:R,className:"bg-gradient-to-r from-primary to-secondary",children:"Proceed to Payment"})]})]}),e.jsx(G,{})]})]})}I.layout=a=>e.jsx(A,{children:a,props:a.props.company});export{I as default};
